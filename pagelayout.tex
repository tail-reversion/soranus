% pagelayout.tex
% Copyright (C) 2018-2020 Kelly Smith.
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License (LPPL),
% either version 1.3c of this license or (at your option)
% any later version. The latest version of this license
% is in the file:
%
%   http://www.latex-project.org/lppl.txt
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Kelly Smith.
%
% This work consists of the files listed in the README.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameters and Setters
%

% Here, I define changeable layout parameters and commands.

\cs_new_protected:Nn \__soranus_set_text_area:nn
  {
    \dim_gset:Nn \textwidth { #1 }
    \dim_gset:Nn \textheight { #2 }
  }


\cs_new_protected:Nn \__soranus_set_column:nnnn
  {
    \dim_gset:Nn \columnwidth
      {
        #2 / 2 % Half the text area.
        - #3 % Minus the column sep.
      }
    \dim_gset:Nn \columnsep { #3 }
    \dim_gset:Nn \columnseprule { #4 }
    \bool_if:nTF { #1 }
      { \twocolumn }
      { \onecolumn }
  }


\cs_new_protected:Nn \__soranus_set_margin_par:nnn
  {
    \dim_gset:Nn \marginparwidth { #1 }
    \dim_gset:Nn \marginparsep { #2 }
    \dim_gset:Nn \marginparpush { #3 }
  }


\cs_new_protected:Nn \__soranus_set_spine_margin:nn
  {
    \dim_gset:Nn \oddsidemargin
      {
        \g__soranus_paper_width_dim
        - \g__soranus_page_width_dim
        + #1 % add spine margin
        + \g__soranus_binding_offset_dim
        - \g__soranus_edge_trim_dim
        - 1in % subtract one inch for hardcoded origin
      }
    \dim_gset:Nn \evensidemargin
      {
        \g__soranus_page_width_dim
        - #1 % subtract spine margin
        - \g__soranus_binding_offset_dim
        - #2 % subtract text width
        + \g__soranus_edge_trim_dim
        - 1in % subtract one inch for hardcoded origin
      }
  }


\cs_new_protected:Nn \__soranus_set_top_margin_and_header:nnn
  {
    \dim_gset:Nn \topmargin
      {
        \g__soranus_top_trim_dim
        + #1 % add top margin
        - #2 % subtract header height
        - #3 % subtract header sep
        - 1in % subtract one inch for hardcoded origin
      }
    \dim_gset:Nn \headheight { #2 }
    \dim_gset:Nn \headsep { #3 }
  }


\cs_new_protected:Nn \__soranus_set_footer:nn
  {
    \dim_gset:Nn \footskip
      {
        #1 % add the footer height
         + #2 % add the footer sep
      }
  }



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Template
%

\DeclareObjectType { pagelayout } { 0 }


\DeclareTemplateInterface { pagelayout } { standard } { 0 }
  {
    text-width        : length  = 30pc,
    text-height       : length  = 50pc,
    two-column        : boolean = false,
    column-sep        : length  = 1pc,
    column-rule-width : length  = 0.4pt,
    margin-par-width  : length  = 5pc,
    margin-par-sep    : length  = 1pc,
    margin-par-push   : length  = 5pt,
    spine-margin      : length  = 1in,
    top-margin        : length  = 1in,
    header-sep        : length  = 1pc,
    header-height     : length  = 1pc,
    footer-sep        : length  = 1pc,
    footer-height     : length  = 1pc
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Implementation
%

\dim_new:N \g__soranus_pagelayout_standard_text_width_dim
\dim_new:N \g__soranus_pagelayout_standard_text_height_dim
\bool_new:N \g__soranus_pagelayout_standard_two_column_bool
\dim_new:N \g__soranus_pagelayout_standard_column_sep_dim
\dim_new:N \g__soranus_pagelayout_standard_column_rule_width_dim
\dim_new:N \g__soranus_pagelayout_standard_margin_par_width_dim
\dim_new:N \g__soranus_pagelayout_standard_margin_par_sep_dim
\dim_new:N \g__soranus_pagelayout_standard_margin_par_push_dim
\dim_new:N \g__soranus_pagelayout_standard_spine_margin_dim
\dim_new:N \g__soranus_pagelayout_standard_top_margin_dim
\dim_new:N \g__soranus_pagelayout_standard_footer_height_dim
\dim_new:N \g__soranus_pagelayout_standard_header_sep_dim
\dim_new:N \g__soranus_pagelayout_standard_header_height_dim
\dim_new:N \g__soranus_pagelayout_standard_footer_sep_dim


\DeclareTemplateCode { pagelayout } { standard } { 0 }
  {
    text-width        = global \g__soranus_pagelayout_standard_text_width_dim,
    text-height       = global \g__soranus_pagelayout_standard_text_height_dim,
    two-column        = global \g__soranus_pagelayout_standard_two_column_bool,
    column-sep        = global \g__soranus_pagelayout_standard_column_sep_dim,
    column-rule-width = global \g__soranus_pagelayout_standard_column_rule_width_dim,
    margin-par-width  = global \g__soranus_pagelayout_standard_margin_par_width_dim,
    margin-par-sep    = global \g__soranus_pagelayout_standard_margin_par_sep_dim,
    margin-par-push   = global \g__soranus_pagelayout_standard_margin_par_push_dim,
    spine-margin      = global \g__soranus_pagelayout_standard_spine_margin_dim,
    top-margin        = global \g__soranus_pagelayout_standard_top_margin_dim,
    header-height     = global \g__soranus_pagelayout_standard_header_height_dim,
    header-sep        = global \g__soranus_pagelayout_standard_header_sep_dim,
    footer-height     = global \g__soranus_pagelayout_standard_footer_height_dim,
    footer-sep        = global \g__soranus_pagelayout_standard_footer_sep_dim
  }
  {
    \AssignTemplateKeys
    \__soranus_set_text_area:nn
      { \g__soranus_pagelayout_standard_text_width_dim }
      { \g__soranus_pagelayout_standard_text_height_dim }
    \__soranus_set_margin_par:nnn
      { \g__soranus_pagelayout_standard_margin_par_width_dim }
      { \g__soranus_pagelayout_standard_margin_par_sep_dim }
      { \g__soranus_pagelayout_standard_margin_par_push_dim }
    \__soranus_set_spine_margin:nn
      { \g__soranus_pagelayout_standard_spine_margin_dim }
      { \g__soranus_pagelayout_standard_text_width_dim }
    \__soranus_set_top_margin_and_header:nnn
      { \g__soranus_pagelayout_standard_top_margin_dim }
      { \g__soranus_pagelayout_standard_header_height_dim }
      { \g__soranus_pagelayout_standard_header_sep_dim }
    \__soranus_set_footer:nn
      { \g__soranus_pagelayout_standard_footer_height_dim }
      { \g__soranus_pagelayout_standard_footer_sep_dim }
    % Set columns last to exploit the internal \clearpage.
    \__soranus_set_column:nnnn
      { \g__soranus_pagelayout_standard_two_column_bool }
      { \g__soranus_pagelayout_standard_text_width_dim }
      { \g__soranus_pagelayout_standard_column_sep_dim }
      { \g__soranus_pagelayout_standard_column_rule_width_dim }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Instance
%

\NewDocumentCommand \DeclarePageLayout { m m }
  { \DeclareInstance { pagelayout } { #1 } { standard } { #2 } }

\NewDocumentCommand \EditPageLayout { m m }
  { \EditInstance { pagelayout } { #1 } { #2 } }

\NewDocumentCommand \UsePageLayout { m }
  { \UseInstance { pagelayout } { #1 } }


\DeclarePageLayout { default } { }



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Designer Utilities
%
