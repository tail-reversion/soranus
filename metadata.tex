% metadata.tex
% Copyright (C) 2018 Kelly Smith.
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License (LPPL),
% either version 1.3c of this license or (at your option)
% any later version. The latest version of this license
% is in the file:
%
%   http://www.latex-project.org/lppl.txt
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Kelly Smith.
%
% This work consists of the files listed in the README.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document Fields
%

\msg_new:nnn { soranus } { document-field-already-set }
  { The~document~field~`#1'~has~already~been~set. }

\msg_new:nnn { soranus } { document-field-not-set }
  { The~document~field~`#1'~has~not~yet~been~set. }


\prop_new:N \g__soranus_document_metadata_prop


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Title & Subtitle
%

\cs_new:Nn \__soranus_set_document_title:n
  { \prop_gput:Nnn \g__soranus_document_metadata_prop { title } { #1 } }

\cs_new:Nn \__soranus_set_document_title_and_subtitle:nn
  {
    \__soranus_set_document_title:n { #1 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { subtitle } { #2 }
  }

\RenewDocumentCommand \title { m o }
  {
    \IfNoValueTF { #2 }
      { \__soranus_set_document_title:n { #1 } }
      { \__soranus_set_document_title_and_subtitle:nn { #1 } { #2 } }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Date
%

\cs_new:Nn \__soranus_set_document_date:n
  { \prop_gput:Nnn \g__soranus_document_metadata_prop { date } { #1 } }

\RenewDocumentCommand \date { m }
  { \__soranus_set_document_date:n { #1 } }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% About
%

\cs_new:Nn \__soranus_set_document_subject:n
  { \prop_gput:Nnn \g__soranus_document_metadata_prop { subject } { #1 } }

\cs_new:Nn \__soranus_set_document_subject_and_keywords:nn
  {
    \__soranus_set_document_subject:n { #1 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { keywords } { #2 }
  }

\NewDocumentCommand \about { m o }
  {
    \IfNoValueTF { #2 }
      { \__soranus_set_document_subject:n { #1 } }
      { \__soranus_set_document_subject_and_keywords:nn { #1 } { #2 } }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Copyright
%

\cs_new:Nn \__soranus_set_document_copyright:nnn
  {
    \prop_gput:Nnn \g__soranus_document_metadata_prop { copyright-year } { #1 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { copyright-holder } { #2 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { copyright-notice } { #3 }
  }

\cs_new:Nn \__soranus_set_document_copyright_with_tag:nnnn
  {
    \__soranus_set_document_copyright:nnn { #1 } { #2 } { #4 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { copyright-tag } { #3 }
  }

\RenewDocumentCommand \copyright { m m o m }
  {
    \IfNoValueTF { #3 }
      { \__soranus_set_document_copyright:nnn { #1 } { #2 } { #3 } }
      { \__soranus_set_document_copyright_with_tag:nnnn { #1 } { #2 } { #3 } { #4 } }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Publisher
%

\cs_new:Nn \__soranus_set_document_publisher:nnn
  {
    \prop_gput:Nnn \g__soranus_document_metadata_prop { publisher-name } { #1 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { publisher-year } { #2 }
    \prop_gput:Nnn \g__soranus_document_metadata_prop { publisher-address } { #3 }
  }

\NewDocumentCommand \publisher { m m m }
  { \__soranus_set_document_publisher:nnn { #1 } { #2 } { #3 } }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Author
%

\int_new:N \g__soranus_document_author_number_int
\int_gzero:N \g__soranus_document_author_number_int

\cs_new:Nn \__soranus_add_document_author:n
  {
    \int_gincr:N \g__soranus_document_author_number_int
    \__soranus_add_document_author_info_aux:nn { name } { #1 }
  }

\cs_new:Nn \__soranus_add_document_author_info_aux:nn
  {
    \tl_set:Nx \l_soranus_tmpa_tl
      { author- \int_to_arabic:n { \g__soranus_document_author_number_int } -#1 }
    \prop_gput:NVn \g__soranus_document_metadata_prop \l_soranus_tmpa_tl { #2 }
  }


\keys_define:nn { soranus / author-info }
  {
    email .code:n           =
      { \__soranus_add_document_author_info_aux:nn { email } { #1 } },
    email .value_required:n = true,

    institution .code:n           =
      { \__soranus_add_document_author_info_aux:nn { institution } { #1 } },
    institution .value_required:n = true,

    phone .code:n           =
      { \__soranus_add_document_author_info_aux:nn { phone } { #1 } },
    phone .value_required:n = true,

    fax .code:n           =
      { \__soranus_add_document_author_info_aux:nn { fax } { #1 } },
    fax .value_required:n = true,

    address .code:n           =
      { \__soranus_add_document_author_info_aux:nn { address } { #1 } },
    address .value_required:n = true,
  }


\cs_new:Nn \__soranus_add_document_author_and_info:nn
  {
    \__soranus_add_document_author:n { #1 }
    \keys_set:nn { soranus / author-info } { #2 }
  }


\RenewDocumentCommand \author { m o }
  {
    \IfNoValueTF { #2 }
      { \__soranus_add_document_author:n { #1 } }
      { \__soranus_add_document_author_and_info:nn { #1 } { #2 } }
  }



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Disable Data Commands after Preamble
%

\tl_map_function:nN { \title \date \about \author \copyright \publisher }
  \@onlypreamble
