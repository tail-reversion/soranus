% fontsize.tex
% Copyright (C) 2018-2020 Kelly Smith.
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License (LPPL),
% either version 1.3c of this license or (at your option)
% any later version. The latest version of this license
% is in the file:
%
%   http://www.latex-project.org/lppl.txt
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Kelly Smith.
%
% This work consists of the files listed in the README.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font Size Template
%

% Define an object that represents a font size command.
\DeclareObjectType { fontsize } { 0 }


% I forbid normal font size switches in the middle of a math environment.
\msg_new:nnn { soranus } { fontsize-in-math-mode }
  { Normal~font~size~commands~are~forbidden~in~math~mode. }

% A general function to wrap boilerplate.
\cs_new_protected:Nn \__soranus_set_fontsize:nn
  {
    \mode_if_math:TF
      { \msg_error:nn { soranus } { fontsize-in-math-mode } }
      {
        \AssignTemplateKeys
        % I do not use \@setfontsize since I handle math mode in my own way
        % and because \@currsize is not used in this class.
        \fontsize { #1 } { #2 } \selectfont
      }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Absolute Template
%


\DeclareTemplateInterface { fontsize } { absolute } { 0 }
  {
    point-size   : length = 10pt,
    baseline-sep : length = 12pt
  }


% Here I define the template variables.
\dim_new:N \l__soranus_fontsize_absolute_point_size_dim
\dim_new:N \l__soranus_fontsize_absolute_baseline_sep_dim


\DeclareTemplateCode { fontsize } { absolute } { 0 }
  {
    point-size   = \l__soranus_fontsize_absolute_point_size_dim,
    baseline-sep = \l__soranus_fontsize_absolute_baseline_sep_dim
  }
  {
    \__soranus_set_fontsize:nn
      { \l__soranus_fontsize_absolute_point_size_dim }
      { \l__soranus_fontsize_absolute_baseline_sep_dim }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Relative Template
%

\DeclareTemplateInterface { fontsize } { relative } { 0 }
  {
    scale : real = 1.1
  }


\fp_new:N \l__soranus_fontsize_relative_scale_fp

\DeclareTemplateCode { fontsize } { relative } { 0 }
  {
    scale = \l__soranus_fontsize_relative_scale_fp
  }
  {
    \__soranus_set_fontsize:nn
      {
        \fp_to_dim:n
          {
            \dim_to_fp:n { \f@size pt }
            * \l__soranus_fontsize_relative_scale_fp
          }
      }
      {
        \fp_to_dim:n
          {
            \dim_to_fp:n { \f@baselineskip }
            * \l__soranus_fontsize_relative_scale_fp
          }
      }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Root Relative Template
%

\DeclareTemplateInterface { fontsize } { root-relative } { 0 }
  {
    scale : real = 1.1
  }


\fp_new:N \l__soranus_fontsize_root_relative_scale_fp

\DeclareTemplateCode { fontsize } { root-relative } { 0 }
  {
    scale = \l__soranus_fontsize_root_relative_scale_fp
  }
  {
    \__soranus_set_fontsize:nn
      {
        \fp_to_dim:n
          {
            \dim_to_fp:n { \g__soranus_normal_point_size_dim }
            * \l__soranus_fontsize_root_relative_scale_fp
          }
      }
      {
        \fp_to_dim:n
          {
            \dim_to_fp:n { \g__soranus_normal_point_size_dim }
            * \l__soranus_fontsize_root_relative_scale_fp
            * \g__soranus_normal_baseline_scale_fp
          }
      }
  }


%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% Instances (normalsize)
%
% Only \normalsize is defined, to keep 2e happy, otherwise templates are used.

\DeclareInstance { fontsize } { normalsize } { root-relative }
  {
    scale = 1.0
  }

\RenewDocumentCommand \normalsize { }
  { \UseInstance { fontsize } { normalsize } }
