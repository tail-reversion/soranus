% potpourri.tex
% Copyright (C) 2018 Kelly Smith.
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License (LPPL),
% either version 1.3c of this license or (at your option)
% any later version. The latest version of this license
% is in the file:
%
%   http://www.latex-project.org/lppl.txt
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Kelly Smith.
%
% This work consists of the files listed in the README.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Date and Time Parsing
%
% When l3regex provides for including precompiled regexen, this will be nicer.
%
% This is NOT completely ISO 8601 compliant, but is good enough.

\regex_const:Nn \c__soranus_iso_date_regex
  {
    \A % must be start of tl
      \d{4} % year
      (:?
        -(:? 0[1-9] | 1[0-2] ) % month
        (:?
          -(:? [0-2]\d | 3[0-1] ) % day
        )?
      )?
    \Z % must be end of tl
  }

\regex_const:Nn \c__soranus_iso_time_regex
  {
    \A
      [0-2]\d % hour
      (:?
        :[0-5]\d % minute
        (:?
          :[0-5]\d % second
        )?
      )?
      (:?
        Z | % UTC or...
        [\+\-\−] % offset plus or minus (third is a Unicode minus)
        (:? 0\d | 1[0-4] ) % hour offset
        (:?
          :[0-5]\d % minute offset
        )?
      )?
    \Z
  }

\regex_const:Nn \c__soranus_iso_datetime_regex
  {
    \A % must be start of tl
      \d{4} % year
      (:?
        -(:? 0[1-9] | 1[0-2] ) % month
        (:?
          -(:? [0-2]\d | 3[0-1] ) % day
          (:?
            T[0-2]\d % hour
            (:?
              :[0-5]\d % minute
              (:?
                :[0-5]\d % second
              )?
            )?
            (:?
              Z | % UTC or...
              [\+\-\−] % offset plus or minus (third is a Unicode minus)
              (:? 0\d | 1[0-4] ) % hour offset
              (:?
                :[0-5]\d % minute offset
              )?
            )?
          )?
        )?
      )?
    \Z % must be end of tl
  }



\cs_new:Nn \__soranus_date_is_valid:nT
  { \regex_match:NnT \c__soranus_iso_date_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_date_is_valid:nF
  { \regex_match:NnF \c__soranus_iso_date_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_date_is_valid:nTF
  { \regex_match:NnTF \c__soranus_iso_date_regex { #1 } { #2 } { #3 } }

\cs_new:Nn \__soranus_time_is_valid:nT
  { \regex_match:NnT \c__soranus_iso_time_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_time_is_valid:nF
  { \regex_match:NnF \c__soranus_iso_time_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_time_is_valid:nTF
  { \regex_match:NnTF \c__soranus_iso_time_regex { #1 } { #2 } { #3 } }

\cs_new:Nn \__soranus_datetime_is_valid:nT
  { \regex_match:NnT \c__soranus_iso_datetime_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_datetime_is_valid:nF
  { \regex_match:NnF \c__soranus_iso_datetime_regex { #1 } { #2 } }
\cs_new:Nn \__soranus_datetime_is_valid:nTF
  { \regex_match:NnTF \c__soranus_iso_datetime_regex { #1 } { #2 } { #3 } }


\NewDocumentCommand \isgooddate { m }
  { \__soranus_date_is_valid:nTF { #1 } { good~date } { bad~date } }

\NewDocumentCommand \isgoodtime { m }
  { \__soranus_time_is_valid:nTF { #1 } { good~time } { bad~time } }

\NewDocumentCommand \isgooddatetime { m }
  { \__soranus_datetime_is_valid:nTF { #1 } { good~datetime } { bad~datetime } }
